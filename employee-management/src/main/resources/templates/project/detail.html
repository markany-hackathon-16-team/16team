<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>프로젝트 상세 정보</title>
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body>
    <div class="container">
        <h1><a href="/" style="text-decoration: none; color: inherit;">마크애니 관리 시스템</a></h1>
        
        <!-- 탭 메뉴 -->
        <div class="tab-menu">
            <a href="/" class="tab-item">대시보드</a>
            <a href="/employees" class="tab-item">인력 관리</a>
            <a href="/projects" class="tab-item active">프로젝트 관리</a>
        </div>
        
        <div class="content">
            <div class="header-actions">
                <a href="/projects" class="btn">목록으로</a>
                <a th:href="@{/projects/{id}/edit(id=${project.projectId})}" class="btn btn-primary">수정</a>
                <button id="recommendBtn" class="btn btn-secondary" th:data-project-id="${project.projectId}">AI 인력 추천</button>
                <button id="completeBtn" class="btn btn-success" th:data-project-id="${project.projectId}" th:if="${project.status.toString() != '완료'}">프로젝트 완료</button>
            </div>
            
            <div class="detail-section">
                <h2 th:text="${project.projectName}">프로젝트명</h2>
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>프로젝트 ID:</label>
                        <span th:text="${project.projectId}"></span>
                    </div>
                    <div class="detail-item">
                        <label>유형:</label>
                        <span th:text="${project.type}"></span>
                    </div>
                    <div class="detail-item">
                        <label>복잡도:</label>
                        <span th:text="${project.complexity}"></span>
                    </div>
                    <div class="detail-item">
                        <label>총 MM:</label>
                        <span th:text="${project.totalMm} + 'MM'"></span>
                    </div>
                    <div class="detail-item">
                        <label>기간:</label>
                        <span th:text="${project.durationMonths} + '개월'"></span>
                    </div>
                    <div class="detail-item">
                        <label>시작일:</label>
                        <span th:text="${project.startDate}"></span>
                    </div>
                    <div class="detail-item">
                        <label>종료일:</label>
                        <span th:text="${project.endDate}"></span>
                    </div>
                    <div class="detail-item">
                        <label>상태:</label>
                        <span th:text="${project.status}"></span>
                    </div>
                    <div class="detail-item">
                        <label>필요 스킬:</label>
                        <span th:text="${project.requiredSkills}"></span>
                    </div>
                    <div class="detail-item full-width">
                        <label>프로젝트 설명:</label>
                        <span th:text="${project.description}"></span>
                    </div>
                    <div class="detail-item full-width">
                        <label>비고:</label>
                        <span th:text="${project.notes}"></span>
                    </div>
                </div>
            </div>
            
            <div class="detail-section">
                <h3>배정된 인력</h3>
                <table class="data-table" th:if="${!assignedEmployees.isEmpty()}">
                    <thead>
                        <tr>
                            <th>직원ID</th>
                            <th>이름</th>
                            <th>역할</th>
                            <th>레벨</th>
                            <th>스킬</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="employee : ${assignedEmployees}">
                            <td th:text="${employee.empId}"></td>
                            <td th:text="${employee.name}"></td>
                            <td th:text="${employee.role}"></td>
                            <td th:text="${employee.level}"></td>
                            <td th:text="${employee.skills}"></td>
                        </tr>
                    </tbody>
                </table>
                <p th:if="${assignedEmployees.isEmpty()}">배정된 인력이 없습니다.</p>
            </div>
            
            <!-- AI 추천 결과 -->
            <div id="recommendationSection" class="detail-section" style="display: none;">
                <h3>AI 인력 추천 결과</h3>
                <div id="recommendationResults"></div>
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('recommendBtn').addEventListener('click', function() {
            const projectId = this.getAttribute('data-project-id');
            const btn = this;
            
            btn.disabled = true;
            btn.textContent = '추천 중...';
            
            fetch(`/projects/${projectId}/recommend`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayRecommendations(data.recommendations);
                } else {
                    alert('추천 중 오류가 발생했습니다.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('추천 중 오류가 발생했습니다.');
            })
            .finally(() => {
                btn.disabled = false;
                btn.textContent = 'AI 인력 추천';
            });
        });
        
        function displayRecommendations(recommendations) {
            const section = document.getElementById('recommendationSection');
            const results = document.getElementById('recommendationResults');
            
            if (recommendations.length === 0) {
                results.innerHTML = '<p>추천할 수 있는 인력이 없습니다.</p>';
            } else {
                let html = '<table class="data-table"><thead><tr><th>직원ID</th><th>이름</th><th>역할</th><th>레벨</th><th>경력</th><th>스킬</th><th>추천이유</th><th>선택</th></tr></thead><tbody>';
                
                recommendations.forEach(rec => {
                    const emp = rec.employee;
                    html += `<tr>
                        <td>${emp.empId}</td>
                        <td>${emp.name}</td>
                        <td>${emp.role}</td>
                        <td>${emp.level}</td>
                        <td>${emp.yearsExp || 0}년</td>
                        <td>${emp.skills || '-'}</td>
                        <td>${rec.reason}</td>
                        <td><input type="checkbox" name="selectedEmployees" value="${emp.empId}" class="employee-checkbox"></td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
                html += '<div style="margin-top: 15px;"><button id="assignSelectedBtn" class="btn btn-primary" onclick="assignSelectedEmployees()">선택된 인력 할당</button></div>';
                results.innerHTML = html;
            }
            
            section.style.display = 'block';
        }
        
        function assignSelectedEmployees() {
            const checkboxes = document.querySelectorAll('.employee-checkbox:checked');
            const selectedEmployeeIds = Array.from(checkboxes).map(cb => cb.value);
            
            if (selectedEmployeeIds.length === 0) {
                alert('할당할 인력을 선택해주세요.');
                return;
            }
            
            const projectId = document.getElementById('recommendBtn').getAttribute('data-project-id');
            
            fetch(`/projects/${projectId}/assign`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    employeeIds: selectedEmployeeIds
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`${selectedEmployeeIds.length}명의 인력이 성공적으로 할당되었습니다.`);
                    location.reload(); // 페이지 새로고침
                } else {
                    alert('인력 할당 중 오류가 발생했습니다: ' + (data.message || ''));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('인력 할당 중 오류가 발생했습니다.');
            });
        }
        
        // 프로젝트 완료 버튼 이벤트
        const completeBtn = document.getElementById('completeBtn');
        if (completeBtn) {
            completeBtn.addEventListener('click', function() {
                if (!confirm('프로젝트를 완료하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                    return;
                }
                
                const projectId = this.getAttribute('data-project-id');
                const btn = this;
                
                btn.disabled = true;
                btn.textContent = '완료 처리 중...';
                
                fetch(`/projects/${projectId}/complete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('오류: ' + data.message);
                        btn.disabled = false;
                        btn.textContent = '프로젝트 완료';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('프로젝트 완료 중 오류가 발생했습니다.');
                    btn.disabled = false;
                    btn.textContent = '프로젝트 완료';
                });
            });
        }
    </script>
</body>
</html>
